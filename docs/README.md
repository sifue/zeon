# ZEN大授業評価サイト ZEON (非公式)

以下に、ZEON(ジオン)の仕様や内部設計についての情報をまとめます。これはZEON運営やZEON開発に関わる人向けの情報です。

## プロジェクト名
ZEON (ZEN university’s classes Evaluation Online Network (Unofficial))

## サービス概要

Googleアカウント認証を用いて、ZEN大学のドメインのGoogleアカウントユーザーのみが利用できるクローズドなZEN大学の授業評価サイト。各授業の評価およびレビューを全てのユーザーが閲覧、および評価できる。
授業を構成する科目の構成については、ZEN大学のシラバスを参考にし、最低限の情報のみをこのサービス内に持つ。

また、ユーザーは特定の科目で開講された授業の評価を行うことができる。
評価は、科目の特定の授業に対して星の数(1~5)と、授業を受けたクォーターの設定、レビューを行うことができる他、自身で変更と削除をすることができる。

またレビューに対しては、他のユーザーが「役に立った」ボタンを押すことができる。役に立ったボタンが押された数は、レビューの表示順に影響を与える。各科目のページを見た際にはその役にたった数が表示され、レビューは最近投稿されたものから順に表示される。科目にはレビューの数、平均評価が表示される。役に立ったは消すことができ、全てのユーザーが全てのレビューに対して役に立ったボタンを押すことができる。

認証ユーザーが表示できる評価ダッシュボードでは、最近つけられたレビュー数件件と平均評価とレビューの数と一緒に科目の一覧が表示される。各科目の詳細ページには科目情報とフォームがついており、そこから評価の投稿、編集、削除ができる。

なおユーザーは、1つの科目に対して、1回のみ評価を行うことができる。

加えてユーザーは、レビューに対して通報を行うことができる。通報の理由を選択して、コメントを運営に対して送ることができる。通報の理由は、「無関係」「不適切」「フェイク」「その他」で、コメントを入れることもでき、役に立ったと同様で通報は全てのユーザーが特定のレビューに対して1度だけ行うことができ、また通報を編集、削除することができる。

また通報数が3件以上のレビューは、運営が確認し、必要に応じて非表示にすることができる。

## 技術スタック
### 言語/プラットフォーム
- Node.js
- TypeScript
- Vercel
- Spabase

### ライブラリ
- Next.js
- TailwindCSS
- Prettier

## アクターの定義

- 非認証ユーザー
- BANされたユーザー
- ZEN大学Googleアカウント認証ユーザー
- 運営スタッフ

## ユースケースの定義

### 非認証ユーザー
- トップページの表示ができる
- サインアップ時の利用規約の表示ができる
- サインアップ時のプライバシーポリシーの表示ができる
- サインアップ時のコミュニティガイドラインの表示ができる
- ZEN大学のGoogleアカウント(zen.ac.jpドメイン)でのサインアップができる

### BANされたユーザー
- ZEN大学のGoogleアカウント(zen.ac.jpドメイン)以外でのサインアップをするとBANされる
- ログインすると、直後にログアウトし、zen.ac.jpドメイン以外のGoogleアカウントであるかBANされたを通知する

### ZEN大学Googleアカウント認証ユーザー
- ログイン後、評価ダッシュボードが自動で表示される
- 評価ダッシュボードでは、最近のレビュー一覧と科目一覧が確認できる
- 評価ダッシュボードから、科目の詳細ページに遷移できる
- 科目の詳細ページでは最低限の科目の情報と全てのレビューが確認できる
- 科目に対して授業の評価を投稿できる
- 投稿した評価を編集できる
- 投稿した評価を削除できる
- 他人が投稿した評価に対して「役に立った」ボタンを押すことができる
- 他人が投稿した評価に対して通報ができる
- 自身が投稿した通報を編集できる
- 自身が投稿した通報を削除できる
- 科目一覧では、全ての科目の評価の数と評価の平均をみることができる
- 科目詳細のレビュー一覧では全てのレビューの役に立ったの数をみることができる

### 運営スタッフ
- 運営スタッフは、全てのユーザーと同じ機能を持つ
- 運営スタッフは、管理者権限を持つ
- 運営スタッフは、全ての通報を確認することができる
- 運営スタッフは、全てのレビューを非表示にすることができる
- 運営スタッフは、評価ダッシュボードから最新の通報を確認することができる

### あえて対応しないユースケース
- 評価に画像をアップロードすることができる (これをするとStorageが有料アカウントが必須になり、開発者がお金を払わないと開発できなくなるため、また卑猥な画像が上がってないかなどの監査が必要となるため)
- 運営スタッフへの管理者権限の付与 (UIを作る必要がないほど数が少ないケースであり、UIを作るとセキュリティリスクがあるため)
- ユーザのBAN (UIを作る必要がないほど数が少ないケースであり、UIを作るとセキュリティリスクがあるため)

## データモデリング概要、用語とそのプログラム内での英語表記について
データベース上ではスネークケース、プログラム内ではロウワーキャメルケース(JSONのプロパティ、変数、関数名)またはアッパーキャメルケース(型名など)で表記する。またSQL関連はすべて小文字で表記し、テーブル名はエンティティを複数名詞にしたものを使用する。(subjects, evaluations, etc.)

データの型は、[Supabase PostgreSQL Data Types/show datatypes](https://supabase.com/docs/guides/database/tables#columns)を参照しながら以下に定義。auth.users意外はpublic.以下のスキーマとする。

### Users
これはSupabaseの認証機能を使用しているため、Supabaseのユーザーテーブル(auth.users)を使用する。

### 管理者(admin)
運営メンバーのうち管理者権限を持つものは、このテーブルにSQLにてUIDを挿入して管理者権限を与える。

- uid (uuid、複合主キー)

### BANされたユーザー(ban_user)
運営メンバーのうち管理者権限を持つものは、このテーブルにSQLにてUIDを挿入して管理者権限を与える。

- uid (uuid、複合主キー)

### 科目(subject)
BANされていない全ての認証ユーザーが見ることができる。

- code 科目コード (varchar、主キー)
- name 科目名 (varchar)
- description 科目の概要  (text)
- opening_year 開講年度 (integer)
- faculties 教員情報(文字列、複数可、jsonb)
- enrollment_grade 想定年次 (integer、インデックス有り)
- teaching_method 授業形態 (varchar)
- subject_requirement 必修/選択 (varchar)
- credit 単位数  (integer)
- quarters 四半期 (文字列、複数可、jsonb)
- objective 授業の目標 (text)
- evaluation_system 評価方法 (text)
- special_notes 特記事項 (text)
- subject_categories 科目カテゴリ(文字列、複数可、jsonb)
- update_at シラバスからの更新日付 (timestamptz)

科目の内容は以上となっており、[詳細](https://syllabus.zen.ac.jp/)はシラバスサイトを確認するようにする。なお、科目(Subject)に対して、授業(class)は毎年、毎クォーターごとに作成されるが、評価(evalucation)対象は授業(class)に対して行う。最新のレビューこそ上に表示される。

### 評価(evaluation)
BANされていない全てのユーザーが閲覧、投稿できる。非表示評価に登録されている場合にはUI上には表示されない。またRLS上では評価者自身が更進、削除できる。

- id 評価ID (bigint、主キー)
- code 科目コード (varchar、複合インデックス1、ユニーク制約1)
- evaluator 評価者 (uuid、複合インデックス1、ユニーク制約1)
- evaluation 評価 (integer、1~5)
- review レビュー (text)
- year 評価した年度 (integer)
- quarter 評価したクォーター (varchar)
- created_at 評価した日時 (timestamptz)
- updated_at 評価を更新した日時 (timestamptz)


### 非表示評価(invisible_evaluations)
RLS上では、adminテーブルに登録されている管理者権限を持つユーザーのみが閲覧、追加、編集、削除することができる。

- id 非表示評価ID (bigint、主キー)
- code 科目コード (varchar、複合インデックス1、ユニーク制約1)
- evaluator 評価者 (uuid、複合インデックス1、ユニーク制約1)
- updated_by 更新者 (uuid)
- update_at 更新日付 (timestamptz)

### 通報(report)
RLS上では、 BANされていない全ての認証ユーザーは通報することができる。通報者自身が自身の通報は追加、閲覧、編集、削除できる。運営は全ての通報を閲覧、編集、削除できる。

- id 通報ID (bigint、主キー)
- evalucation_id 評価ID (bigint、複合インデックス1、ユニーク制約1)
- evaluator 評価者 (uuid、複合インデックス1、ユニーク制約1)
- is_irrelevant 無関係 (boolean、デフォルト値はfalse)
- is_inappropriate 不適切 (boolean、デフォルト値はfalse)
- is_fake フェイク (boolean、デフォルト値はfalse)
- is_other その他 (boolean、デフォルト値はfalse)
- comment コメント (text)
- created_at 通報した日時 (timestamptz)


### 役に立った(useful)
RLS上では、BANされていない全てのユーザーは閲覧できる。役に立ったボタンを押したユーザーのみが自身の役に立ったは追加、編集、削除できる。運営は全ての役に立ったを閲覧、追加、編集、削除できる。

- id 役に立ったID (bigint、主キー)
- evalucation_id 評価ID (bigint、複合インデックス1、ユニーク制約1)
- uid 役に立ったと言った人 (uuid、複合インデックス1、ユニーク制約1)
- created_at 役に立ったを押した日時 (timestamptz)





